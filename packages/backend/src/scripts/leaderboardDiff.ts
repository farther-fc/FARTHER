import { dayUTC, getStartOfMonthUTC } from "@farther/common";
import { prisma } from "../prisma";

const leaderboardFids = [
  394023, 402682, 3741, 275519, 350139, 19783, 296315, 340034, 468087, 492067,
  330083, 540412, 585995, 392597, 448920, 271878, 483462, 416401, 397963,
  403619, 331948, 268455, 203666, 528242, 396484, 501095, 409573, 509022,
  346080, 483365, 357596, 245579, 382384, 250664, 368013, 375536, 218142,
  451841, 340986, 440747, 408746, 377111, 459170, 234616, 502822, 397392,
  283056, 385627, 445359, 502617, 461302, 378285, 422438, 318447, 13404, 477292,
  784277, 455965, 285998, 445210, 402888, 245902, 8405, 263574, 368345, 383877,
  403573, 421000, 430312, 385793, 262566, 270228, 383360, 415368, 360623,
  443305, 501794, 247653, 500244, 12626, 15776, 456675, 315697, 509971, 473065,
  597941, 3372, 243818, 395131, 470886, 449882, 380660, 368412, 195117, 332316,
  528149, 365209, 375140, 421001, 471309, 270138, 627302, 423378, 510029,
  260433, 422233, 302229, 528914, 511972, 324741, 438822, 326040, 466111,
  451952, 12400, 516028, 296241, 343324, 316492, 418456, 422334, 469243, 485585,
  409032, 417418, 249958, 419852, 431085, 268608, 211535, 323070, 10095, 512534,
  15513, 449539, 350698, 386213, 548867, 400074, 378422, 379435, 500988, 343855,
  192631, 420657, 407704, 511479, 308284, 423036, 443863, 382261, 405729,
  466926, 410948, 301385, 373025, 500235, 460847, 501801, 467312, 528707,
  423311, 389066, 435501, 417451, 336594, 301144, 14553, 278653, 353603, 292783,
  386287, 269775, 407705, 274563, 341438, 323063, 665530, 456735, 420601, 17360,
  628195, 415872, 406564, 646093, 283144, 281290, 553958, 418671, 403398,
  422809, 420493, 420374, 675076, 631749, 422910, 279037, 434358, 293760,
  454819, 7418, 349986, 733071, 348569, 326677, 420359, 406493, 269405, 277952,
  217261, 415902, 437666, 309242, 296050, 535208, 428449, 542351, 519114,
  439799, 372581, 393348, 328041, 449264, 512856, 304818, 440080, 347364,
  308094, 416361, 434955, 428228, 385766, 343971, 461236, 317501, 474514,
  444156, 306610, 480642, 380913, 414401, 428341, 17454, 403399, 462883, 318589,
  641968, 508261, 411656, 302556, 815069, 380136, 334811, 299247, 304336,
  423331, 239828, 485965, 447195, 484959, 445335, 420958, 378030, 486142,
  445226, 399658, 333772, 422514, 499275, 397411, 260299, 278406, 263309,
  513581, 308827, 390598, 644667, 288578, 354220, 373242, 495081, 379089,
  474644, 512482, 13201, 393452, 273379, 268977, 398825, 525136, 528550, 14511,
  307568, 308410, 364017, 198538, 7472, 518129, 366075,
];

async function leaderboardDiff() {
  const tippersWithScores = await prisma.user.findMany({
    where: {
      tipperScores: {
        some: {
          createdAt: {
            gte: dayUTC("2024-08-18 05:05:32.139").toDate(),
          },
        },
      },
    },
  });

  console.log(
    "missingFids",
    tippersWithScores
      .filter((t) => !leaderboardFids.includes(t.id))
      .map((t) => t.id),
  );

  const kyleP = await prisma.user.findFirst({
    where: {
      id: 247143,
    },
    include: {
      tipsGiven: {
        where: {
          invalidTipReason: null,
          createdAt: {
            gte: getStartOfMonthUTC(0),
          },
        },
        include: {
          tippee: {
            select: {
              tipAllowances: {
                where: {
                  createdAt: {
                    gte: getStartOfMonthUTC(0),
                  },
                },
                select: {
                  id: true,
                },
              },
            },
          },
        },
      },
    },
  });

  console.log("kyleP tip count", kyleP?.tipsGiven.length);

  const filteredTips = kyleP?.tipsGiven.filter(
    (t) => t.tippee.tipAllowances.length === 0,
  );

  const totalActiveDays = new Set(kyleP?.tipsGiven.map((t) => t.tipAllowanceId))
    .size;

  console.log("totalActiveDays", totalActiveDays);

  console.log("filtered tips", filteredTips?.length);
}

leaderboardDiff();
